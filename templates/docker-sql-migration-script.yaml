parameters:
  - name: azureSubscription
    type: string
  - name: solutionFolder
    type: string
    default: ''
  - name: projectFolder
    type: string
    default: ''
  - name: azureContainerRegistryName
    type: string
  - name: imageName
    type: string
    default: rwdeprdevdockerimage
  - name: repositoryName
    type: string
  - name: branchName
    type: string

steps:
  - bash: |
        echo "##vso[task.setvariable variable=branchName;]${{ parameters.branchName }}"
    displayName: "Set new branch name"

  - bash: |
        echo "##vso[task.setvariable variable=branchName;]main"
    displayName: "Set new branch name if PullRequest"
    condition: ${{ contains(parameters.branchName, 'refs_pull') }}

  - task: NuGetAuthenticate@1
    displayName: 'Authenticate to NuGet'

  - task: Docker@2
    displayName: 'Build Docker Database Migrations Image'
    inputs:
      repository: ${{parameters.imageName}}
      command: build
      buildContext:  ${{parameters.solutionFolder}}/BackendAccountService.Data/Scripts/
      dockerfile: ${{parameters.solutionFolder}}/BackendAccountService.Data/Scripts/Dockerfile
      tags: $(Build.BuildNumber)-database-migrations

  - task: AzureCLI@2
    displayName: 'Push Docker Database Migrations Image to ACR'
    inputs:
      azureSubscription: ${{parameters.azureSubscription}}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        docker images
        az acr login --name ${{parameters.azureContainerRegistryName}}
        docker tag ${{parameters.imageName}}:$(Build.BuildNumber)-database-migrations ${{parameters.azureContainerRegistryName}}.azurecr.io/${{parameters.repositoryName}}:$(branchName)-$(Build.BuildNumber)-database-migrations
        docker push ${{parameters.azureContainerRegistryName}}.azurecr.io/${{parameters.repositoryName}}:$(branchName)-$(Build.BuildNumber)-database-migrations