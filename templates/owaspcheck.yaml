parameters:
  - name: solutionFolder
    type: string
    default: ''
  - name: projectFolder
    type: string
    default: ''
  - name: componentDirectory
    type: string
    default: ''

steps:
  - script: |
      echo '${{parameters.solutionFolder}}'
    displayName: 'Root Folder to Scan'

  - task: PythonScript@0
    displayName: 'Replace Cyrillic Characters in .csproj File'
    inputs:
      scriptSource: 'inline'
      script: |
        import os
        def replace_cyrillic_with_latin(file_path):
            cyrillic_to_latin = {'о': 'o', 'е': 'e', 'х': 'x'}
            with open(file_path, 'r', encoding='utf-8') as file:
                content = file.read()
            for cyrillic_char, latin_char in cyrillic_to_latin.items():
                content = content.replace(cyrillic_char, latin_char)
            with open(file_path, 'w', encoding='utf-8') as file:
                file.write(content)

        def file_exists(file_path):
          return os.path.isfile(file_path)


        file_path = '$(Build.SourcesDirectory)/src/EPR.Payment.Facade.Common.UnitTests/EPR.Payment.Facade.Common.UnitTests.csproj'
        if file_exists(file_path): 
          replace_cyrillic_with_latin(file_path)
          print(f'Replaced Cyrillic characters with Latin characters in {file_path}.')
        
  - task: DockerInstaller@0
    displayName: 'Docker Installer'
    inputs:
      dockerVersion: 17.09.0-ce
      releaseType: stable
      
  - task: AzureKeyVault@2
    displayName: 'Get OWASP NVD Key'
    inputs:
      azureSubscription: 'AZD-RWD-DEV1'
      KeyVaultName: 'DEVRWDINFKV1401'
      SecretsFilter: 'OwaspNVDKey'
            
  - task: AzureKeyVault@2
    displayName: 'Get OWASP NVD OSS Username'
    inputs:
      azureSubscription: 'AZD-RWD-DEV1'
      KeyVaultName: 'DEVRWDINFKV1401'
      SecretsFilter: 'OwaspNVDOssUsername'
      
  - task: AzureKeyVault@2
    displayName: 'Get OWASP NVD OSS Password'
    inputs:
      azureSubscription: 'AZD-RWD-DEV1'
      KeyVaultName: 'DEVRWDINFKV1401'
      SecretsFilter: 'OwaspNVDOssPassword'

  - script: |
      docker pull owasp/dependency-check-action:latest
    displayName: 'Pull OWASP Image'
    
  - script: |
      docker run --rm -v $(System.DefaultWorkingDirectory)/${{parameters.solutionFolder}}:/workspace owasp/dependency-check-action:latest \
                 --nvdApiKey $(OwaspNVDKey) \
                 --project ${{parameters.projectFolder}} \
                 --scan /workspace \
                 --exclude '**/*Tests.csproj' \
                 --format HTML --format JUNIT \
                 --ossIndexUsername $(OwaspNVDOssUsername) \
                 --ossIndexPassword $(OwaspNVDOssPassword) \
                 --out /workspace
    displayName: 'Run dependency check'
    
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'dependency-check-junit.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)/${{parameters.solutionFolder}}'
    displayName: 'Publish Dependency Check Test Results if Available'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/${{parameters.solutionFolder}}/dependency-check-report.html'
      artifact: 'OWASP DOCKER HTML'
      publishLocation: 'pipeline'
    displayName: 'Publish OWASP Artifact'
  
  # Not needed, probably given the short lifetime of agent, left commented out in case of future need:
  #- script: |
  #    docker image rm owasp/dependency-check-action:latest
  #  displayName: 'Remove OWASP Image'