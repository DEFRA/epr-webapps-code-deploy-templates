parameters:
  - name: solutionFolder
    type: string
    default: ''
  - name: testProjectFolder
    type: string
    default: ''
  - name: componentDirectory
    type: string
    default: ''

steps:
  - script: |
      echo '${{parameters.solutionFolder}}/${{parameters.componentDirectory}}/${{parameters.testProjectFolder}}/${{parameters.testProjectFolder}}.csproj'

  - task: AzureCLI@2
    displayName: "Download files from storage"
    inputs:
      azureSubscription: 'AZD-RWD-DEV1'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az storage blob download --account-name devrwdwebsa1401 --container-name owasp-file-storage --name nvdcve-1.1-2024.json.gz --file $(Build.ArtifactStagingDirectory)/nvdcve-1.1-2024.json.gz 
        az storage blob download --account-name devrwdwebsa1401 --container-name owasp-file-storage --name nvdcve-1.1-2024.meta --file $(Build.ArtifactStagingDirectory)/nvdcve-1.1-2024.meta
        echo "Downloaded files:"
        ls -l $(Build.ArtifactStagingDirectory)
        
  - script: |
      echo "##vso[task.setvariable variable=BASE_PATH]$(Build.ArtifactStagingDirectory)"
    displayName: 'Set Base Path Variable'
  
  - task: dependency-check-build-task@6
    displayName: "Owasp Dependency Check"
    retryCountOnTaskFailure: 3
    inputs:
      projectName: 'owasptest'
      scanPath: '${{parameters.solutionFolder}}/${{parameters.componentDirectory}}/${{parameters.testProjectFolder}}/${{parameters.testProjectFolder}}.csproj'
      format: 'XML, HTML'
      additionalArguments: '--nvdDatafeed $(BASE_PATH)/nvdcve-1.1-2024.json.gz --nvdDatafeed $(BASE_PATH)/nvdcve-1.1-2024.meta'
      verbose: true

  - task: DownloadBuildArtifacts@1
    displayName: 'Download Pipeline Artifact'
    inputs:
      buildType: 'current'
      downloadType: 'specific'
      itemPattern: '**'
      downloadPath: '$(Common.TestResultsDirectory)'
      cleanDestinationFolder: false

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Common.TestResultsDirectory)'
      Contents: '**'
      TargetFolder: '$(System.DefaultWorkingDirectory)'

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'dependency-check/dependency-check-report.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      testRunTitle: 'Dependency Check'
      buildPlatform: 'owasp'
      mergeTestResults: 'true'
      buildConfiguration: '$(BuildConfiguration)'
