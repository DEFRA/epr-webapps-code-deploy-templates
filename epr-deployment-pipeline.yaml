parameters:
- name: imageTag
  type: string
  default: 'main-latest'
- name: azureSubscription
  type: string
- name: acrName
  type: string
- name: registryName
  type: string
- name: serviceName
  type: string
- name: targetEnvironment
  type: string
- name: runAutomationTests #will let us toggle automation tests on or off
  type: boolean
  default: false

resources:
  repositories:
    - repository: AutomationTesting
      name: RWD-CPR-EPR4P-ADO/epr-playwright-bdd
      type: git
      ref: automation-testing-sam

jobs:
- deployment: 'DeployAppCode'
  environment: ${{ parameters.targetEnvironment }}
  strategy:
    runOnce:
      deploy:
        steps:
          - template: templates/deployment.yaml
            parameters:
              imageTag: ${{ parameters.imageTag }}
              azureSubscription: ${{ parameters.azureSubscription }}
              acrName: ${{ parameters.acrName }}
              registryName: ${{ parameters.registryName }}
              serviceName: ${{ parameters.serviceName }}
              targetEnvironment: ${{ parameters.targetEnvironment }}



- ${{ if eq(parameters.runAutomationTests, true) }}:
  - job: RunAutomationTest
    dependsOn: DeployAppCode
    condition: eq('${{ parameters.targetEnvironment }}', 'development')
    displayName: 'Run TST Automation Testing'
    steps:
      - checkout: AutomationTesting
      - template: automation-testing.yaml@AutomationTesting
        parameters:
          env: 'tst'